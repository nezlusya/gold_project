version: "3.9"

services:
  # ---------- PostgreSQL ----------
  postgres:
    image: postgres:14
    container_name: postgres
    environment:
      POSTGRES_USER: gold_user
      POSTGRES_PASSWORD: gold_pass
      POSTGRES_DB: gold_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # ---------- ClickHouse ----------
  clickhouse:
    image: clickhouse/clickhouse-server:23.8
    container_name: clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse

  # ---------- MinIO ----------
  minio:
    image: minio/minio:RELEASE.2023-07-07T07-13-57Z
    container_name: minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio123
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data

  # ---------- Airflow ----------
  airflow:
    image: apache/airflow:2.6.3
    container_name: airflow
    environment:
      - AIRFLOW__CORE__EXECUTOR=SequentialExecutor
      - AIRFLOW__CORE__SQL_ALCHEMY_CONN=postgresql+psycopg2://gold_user:gold_pass@postgres/gold_db
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
    volumes:
      - ./airflow/dags:/opt/airflow/dags
    ports:
      - "8080:8080"
    command: >
      bash -c "airflow db init &&
               airflow users create --username admin --password admin --firstname Admin --lastname User --role Admin --email admin@example.com &&
               airflow webserver & airflow scheduler"
    depends_on:
      - postgres

  # ---------- Streamlit ----------
  streamlit:
    build: ./streamlit
    container_name: streamlit
    ports:
      - "8501:8501"
    volumes:
      - ./streamlit:/app
      - ./db:/db
    depends_on:
      - postgres
      - clickhouse
    environment:
      - POSTGRES_URL=postgresql://gold_user:gold_pass@postgres:5432/gold_db
      - CLICKHOUSE_URL=http://clickhouse:8123
      - MINIO_URL=http://minio:9000
      - MINIO_ACCESS_KEY=minio
      - MINIO_SECRET_KEY=minio123

  # ---------- MLflow ----------
  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.8.1
    container_name: mlflow
    environment:
      MLFLOW_TRACKING_URI: http://mlflow:5000
      BACKEND_STORE_URI: postgresql://gold_user:gold_pass@postgres:5432/gold_db
      ARTIFACT_ROOT: s3://mlflow/
      AWS_ACCESS_KEY_ID: minio
      AWS_SECRET_ACCESS_KEY: minio123
    ports:
      - "5000:5000"
    depends_on:
      - postgres
      - minio

  # ---------- Apache Superset ----------
  superset:
    image: apache/superset:2.1.0
    container_name: superset
    environment:
      - SUPERSET_SECRET_KEY=supersetsecretkey
      - DATABASE_URL=postgresql://gold_user:gold_pass@postgres/gold_db
    ports:
      - "8088:8088"
    depends_on:
      - clickhouse
      - postgres
    volumes:
      - superset_home:/app/superset_home

volumes:
  postgres_data:
  clickhouse_data:
  minio_data:
  superset_home:
